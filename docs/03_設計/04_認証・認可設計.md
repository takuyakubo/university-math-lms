# 認証・認可設計

このドキュメントでは、大学生向け数学特化型学習管理システム（LMS）の認証・認可メカニズムについて定義します。

## 認証システム概要

### 認証方式

本システムでは以下の認証方式を実装します：

1. **JWT（JSON Web Token）認証**
   - 主要な認証メカニズムとして採用
   - ステートレスな認証を実現
   - アクセストークンとリフレッシュトークンの2種類を使用

2. **OAuth2.0 / OpenID Connect**
   - 将来的な拡張として実装予定
   - 大学の既存認証システムとの連携を想定

3. **多要素認証（MFA）**
   - 管理者アカウントと教員アカウント向けに実装
   - モバイルアプリまたはSMS/メールによるワンタイムパスワード

### 認証フロー

1. **ユーザーログイン**
   - ユーザーがログインフォームから認証情報を送信
   - サーバーが認証情報を検証し、成功時にJWTトークンを発行
   - クライアントはトークンを保存し、以降のリクエストに添付

2. **トークン検証**
   - 保護されたリソースへのアクセス時にトークンを検証
   - 有効期限、署名、クレームを確認
   - 無効なトークンの場合は401 Unauthorizedを返却

3. **トークンリフレッシュ**
   - アクセストークン有効期限（15分）経過時
   - リフレッシュトークンを使用して新しいアクセストークンを取得
   - リフレッシュトークンの有効期限は7日間

## 認可システム概要

### ロールベースアクセス制御（RBAC）

以下の主要ロールを定義し、各ロールに適切な権限を付与します：

1. **Student（学生）**
   - 自分の学習コンテンツへのアクセス
   - 自分の学習進捗の確認
   - 限定的なフォーラム・メッセージ機能

2. **Instructor（講師）**
   - 担当コースの管理とコンテンツ作成
   - 学生の進捗確認と評価
   - フィードバック提供とメッセージング

3. **ContentCreator（コンテンツ作成者）**
   - 教材・問題の作成と編集
   - コースストラクチャの設計
   - 限定的な利用統計の閲覧

4. **Administrator（管理者）**
   - システム全体の設定と管理
   - すべてのコンテンツとユーザーへのアクセス
   - 高度な分析とレポート機能

### 権限（Permissions）

各機能領域に対する細粒度の権限を定義します：

1. **ユーザー管理**
   - `users:read`
   - `users:create`
   - `users:update`
   - `users:delete`

2. **コース管理**
   - `courses:read`
   - `courses:create`
   - `courses:update`
   - `courses:delete`
   - `courses:publish`

3. **コンテンツ管理**
   - `content:read`
   - `content:create`
   - `content:update`
   - `content:delete`

4. **学習管理**
   - `progress:read`
   - `progress:update`
   - `grades:read`
   - `grades:create`
   - `grades:update`

5. **システム管理**
   - `system:settings`
   - `system:logs`
   - `system:backup`

### アクセス制御の実装

1. **認証レイヤー**
   - ミドルウェアでJWTトークンを検証
   - 認証されていないリクエストを拒否

2. **認可レイヤー**
   - ロールと権限に基づいてアクセスを制御
   - デコレータやミドルウェアで権限チェック

3. **コンテキストベースの制限**
   - ユーザーに関連するリソースのみアクセス可能
   - 例：学生は自分のコースと進捗のみ閲覧可能

## セキュリティ対策

### パスワードポリシー

- 最小8文字以上、英数字と特殊文字を含む
- bcryptによるパスワードハッシュ保存
- 定期的なパスワード変更の推奨（90日ごと）

### セッション管理

- JWTの有効期限を短く設定（15分）
- リフレッシュトークンの厳格な管理
- 30分間の無活動後、自動ログアウト

### 脆弱性対策

- CSRF対策：トークンベースの保護
- XSS対策：入力検証とエスケープ処理
- クリックジャッキング対策：X-Frame-Optionsヘッダ

## 監査とログ

### セキュリティ監査

- 認証・認可イベントの詳細記録
- 重要アクションの監査証跡
- 定期的なセキュリティレビュー

### ログ管理

- 認証失敗の記録と分析
- 管理者アクションの記録
- 不審なアクセスパターンの検出

## 展開戦略

### 段階的実装

1. **フェーズ1**: JWTベースの基本認証・認可
2. **フェーズ2**: 多要素認証の導入
3. **フェーズ3**: OAuth2.0/OIDCによる外部認証統合
